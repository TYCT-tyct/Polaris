# Module 4: ClawBot — 推文计数预测引擎

> 用历史数据 + 实时速率 + LLM 分析，预测 Elon（及其他人）的推文数量。
> 当预测结果与市场定价存在显著偏差时，做方向性交易。

---

## 一、与 Module 3 的边界

| | Module 3 SpreadHunter | Module 4 ClawBot |
|---|---|---|
| **回答的问题** | "这个价格正不正常？" | "Elon 这周会发多少条？" |
| **需要预测吗** | 不需要 | 需要 |
| **持仓时间** | 分钟到小时 | 小时到天 |
| **利润来源** | 流动性溢价 | 预测 Alpha |
| **风险类型** | 市场微结构风险 | 方向性风险 |
| **时间窗口** | 开盘期 + 全程做市 | 窗口 30%-80% |

两者不冲突，可以同时运行，赚不同的钱。

---

## 二、预测引擎：四层融合

预测不是一个模型——它是四个独立信号源的加权融合。每层有不同的优势和劣势，组合后比任何单层都准。

### Layer 1：统计基线（Statistical Baseline）

**数据来源**：`fact_tweet_metric_daily`

**方法**：
- 计算过去 7 天日均 R₇ 和过去 28 天日均 R₂₈
- 趋势系数 T = (R₇ - R₂₈) / R₂₈
- 基线预测 = R₇ × 窗口天数 × (1 + T × 衰减因子)
- 衰减因子 = 0.5（趋势不会无限延续）

**举例**（Jan 2026 真实数据回测）：
- Jan 9-16 实际 ~550，日均 ~79
- Jan 16-23 预测：R₇=79, R₂₈≈85, T=-7%, 衰减后 T'=-3.5%
- 预测 = 79 × 7 × 0.965 = 534
- 实际 ~470 → 误差 14%

**优势**：简单、稳定、无幻觉
**劣势**：在 regime shift 时滞后（如上例）
**权重**：窗口未开始时 35%，窗口过 50% 后降到 15%

### Layer 2：行为模式分析（Behavioral Pattern）

**数据来源**：`fact_tweet_post`

从个帖数据中提取当前"行为模式"特征向量：

| 特征 | 计算方式 | 含义 |
|------|---------|------|
| 日内爆发度 | 最高 1h 帖量 / 日均时帖量 | >3 = 暴发模式 |
| 转发比 | is_retweet 比例 | 高 = 分享模式，量大 |
| 原创比 | 非 reply 非 retweet 比例 | 高 = 深思模式，量小 |
| 活跃时长 | 每天有帖子的小时数 | 多 = 高活跃期 |
| 内容长度均值 | char_len 均值 | 短 = 快速互动，量大 |
| 周末衰减 | 周末日均 / 工作日日均 | 低 = 周末不发 |

**政权分类**：用过去 3 天的特征向量，与历史特征向量做余弦相似度匹配，找到最相似的历史时期。然后用那个历史时期的周推文量作为参考。

**举例**：
- 当前模式：转发比 30%，日内爆发度 4.2，活跃 14h/天
- 最相似历史期：Dec 16-23, 2025（转发比 28%，爆发度 3.8，活跃 15h）
- 那周实际 = 340-359
- 参考估计 = 340-360

**优势**：能捕捉 regime shift（行为变化先于数量变化）
**劣势**：历史样本少时匹配不准
**权重**：窗口未开始时 25%，窗口过 50% 后降到 10%

### Layer 3：实时速率外推（Real-time Extrapolation）

**数据来源**：XTracker API 实时 + `fact_tweet_metric_daily` 窗口内累计

**方法**：
- 当前窗口已过 d 天，累计 C 条
- 当前日均速率 R_now = C / d
- 但速率不恒定——用日历调整：
  - 剩余天中有几天是 weekend？历史周末衰减系数 = W
  - 调整后预测 = C + R_now × 工作日剩余 + R_now × W × 周末剩余

**精度随时间提升**：

| 窗口进度 | 预测误差（历史中位数） |
|---------|-------------------|
| 20% | ±25% |
| 40% | ±12% |
| 60% | ±6% |
| 80% | ±3% |

**优势**：窗口后半段精度极高
**劣势**：窗口前段无数据时无用
**权重**：窗口过 30% 后从 0% 线性增长到 60%

### Layer 4：LLM 结构化分析

**数据来源**：Layer 1-3 的输出 + 最近帖子内容摘要

**LLM 不做什么**：
- 不做数值预测（"Elon 会发 237 条"）
- 不做没有数据支撑的猜测
- 不替代统计模型

**LLM 做什么**：

给 LLM 的输入：
1. 过去 4 周每日推文量表格
2. 最近 20 条帖子的内容摘要和主题
3. Layer 1 的统计预测值
4. Layer 2 的行为模式匹配结果
5. 当前已知的外部事件（如果有）

让 LLM 回答：
1. "当前行为模式最类似历史上哪个时期？与 Layer 2 的匹配是否一致？"
2. "统计预测 vs 行为模式预测的矛盾如何解释？"
3. "是否有 Layer 1-3 无法捕捉的因素可能影响结果？"
4. "给出你对预测区间的置信度调整建议（上调/下调/维持）"

**LLM 的输出不是数字——是对 Layer 1-3 的"审阅意见"**。

例如：LLM 可能说"统计预测 330 但最近帖子显示 Elon 在减少政治讨论，行为模式更接近 Jun 2025 的低活跃期，建议下调 15%"→ 调整后 280。

**优势**：能整合非数值因素
**劣势**：可能过度自信或产生幻觉
**权重**：始终 10-15%（作为校准层，不作为主信号）
**成本**：每次分析约 $0.01-0.05（使用 GPT-4o-mini 或 Claude Haiku）

### 融合公式

```
最终预测 = W₁ × 统计基线 + W₂ × 行为模式 + W₃ × 实时外推 + W₄ × LLM调整

权重随窗口进度动态调整：
                    窗口 0-30%    30-60%    60%+
W₁ 统计基线          35%          20%       10%
W₂ 行为模式          25%          15%       10%
W₃ 实时外推          25%          50%       65%
W₄ LLM 校准          15%          15%       15%
```

**为什么实时外推权重最终最高？** 因为实际数据永远比模型可靠。窗口过 60% 后，你已经有 4-5 天的实际推文数，剩余 2-3 天的预测误差很小。

---

## 三、从预测到交易：错价检测

### 3.1 把点估计转化为概率分布

预测引擎输出的是一个数字（如"预测周推文 250"），但市场是 bin 制（200-220, 220-240, 240-260...）。需要把点估计转化为各 bin 的概率。

**方法**：以预测均值为中心，用历史预测误差分布生成正态分布（or 更适合的分布），然后计算每个 bin 的概率。

例如：
- 预测均值 = 250，历史标准差 = 35
- P(200-220) = P(z < -0.86) - P(z < -1.43) ≈ 12%
- P(220-240) = P(z < -0.29) - P(z < -0.86) ≈ 19%
- P(240-260) = P(z < 0.29) - P(z < -0.29) ≈ 22%  ← 最高
- P(260-280) = P(z < 0.86) - P(z < 0.29) ≈ 19%
- P(280-300) = P(z < 1.43) - P(z < 0.86) ≈ 12%

### 3.2 对比市场定价

市场给每个 bin 的 ask 价格就是隐含概率。比较你的概率和市场概率：

| Bin | 你的概率 | 市场 ask 价 | 差值 | 交易？ |
|-----|---------|-----------|------|--------|
| 200-220 | 12% | 0.08 | +4% | 不够（< 8%） |
| 220-240 | 19% | 0.14 | +5% | 不够 |
| **240-260** | **22%** | **0.13** | **+9%** | **✅ 买入** |
| 260-280 | 19% | 0.22 | -3% | 市场高估 → 可卖 |
| 280-300 | 12% | 0.20 | -8% | 市场高估 → 可卖 |

### 3.3 最小 edge 要求

只有当 你的概率 - 市场价格 ≥ **8%** 时才交易：
- 2% winner fee（如果这个 bin 赢了）
- 3% 平均滑点（实际成交价 vs 显示价格）
- 3% 安全边际（模型不完美）

---

## 四、仓位管理

### 4.1 Kelly 1/4 公式

假设你估算某 bin 真实概率 p，市场价 q：
- 净赔率 b = 0.98/q - 1（扣 2% winner fee）
- Full Kelly f = (b × p - (1-p)) / b
- 实际仓位 = min(f/4, 15%) × 总资金

**Kelly 的美妙之处**：edge 大 → 仓位大；edge 小 → 仓位小；负 edge → 仓位 = 0（自动不交易）。

### 4.2 硬限制

| 规则 | 数值 |
|------|------|
| 单 bin 最大仓位 | 总资金 15% |
| 同窗口最多买入 bin 数 | 3 |
| 总暴露上限 | 总资金 50% |
| 现金储备 | 始终保留 20% |

---

## 五、退出策略

由简到复杂，五级退出：

**Level 1：硬止损**（不可协商）
- 单仓亏 15% → 立即平仓
- 日亏 $50 → 当天不新开仓
- 周亏 $100 → 全停人工审核

**Level 2：信号反转**
- 新数据更新后重新预测，如果你的公平价已经 < 你的买入价 → 原始判断被否定 → 平仓
- 这是最有价值的退出：基于**信息更新**而非价格噪声

**Level 3：收敛止盈**
- 市场价向你的公平价回归 50% → 卖一半
- 回归 80% → 全卖

**Level 4：时间交接**
- 距结算 < 48h → 交给 Module 2 的 Strategy G 管理
- 持有超过窗口 70% 无显著盈亏 → 平仓释放资金

**Level 5：持有到结算**
- 仅在你的公平概率 > 40% 且信心极高时允许
- 赢 = $1/份 - 买入价；输 = -买入价

---

## 六、校准系统

预测引擎的**自我修正**是长期盈利的关键。

### 6.1 每次预测记录

每次预测完整记录到数据库：
- 预测时间、窗口 ID
- 各层独立预测值（统计/行为/速率/LLM）
- 融合后的最终预测
- 各 bin 概率分布
- 市场快照（各 bin 当时价格）
- 信心水平
- 结算后回填：实际推文数、命中 bin、Brier score

### 6.2 校准指标

| 指标 | 健康 | 警告 | 触发停机 |
|------|------|------|---------|
| Top-1 准确率 | > 30% | 20-30% | < 20% 连续 4 周 |
| Top-2 准确率 | > 55% | 40-55% | < 40% 连续 4 周 |
| Brier Score | < 0.20 | 0.20-0.30 | > 0.30 连续 4 周 |
| 预测偏差方向 | 无系统偏差 | 连续 3 周同方向 | 连续 5 周 |

### 6.3 自动修正

- 连续 3 周预测偏高 → 加入 -5% 修正因子
- 连续 3 周预测偏低 → 加入 +5% 修正因子
- Brier > 0.25 → 仓位自动降为 Kelly 1/8（减半）
- Top-1 < 20% 持续 4 周 → 停止实盘，回到 paper trading

---

## 七、扩展到"其他人"

系统设计不绑定 Elon。任何 XTracker 追踪的账号都可以用同样的框架：

| 账号 | 已有数据？ | 市场存在？ | 优先级 |
|------|----------|----------|--------|
| @elonmusk | ✅ 40+ 周 | ✅ 最活跃 | P0 |
| 其他 XTracker 账号 | 取决于采集 | 取决于 Polymarket | P1 |

**扩展方式**：
- `dim_account` 支持多账号
- `fact_tweet_metric_daily` 按 account_id 分区
- 预测引擎接收 account_id 参数，对不同账号独立运行
- 行为模式库按账号独立建立（不同人有不同的发帖模式）

---

## 八、跨市场情报（最强信号）

当短期市场和长期市场有时间重叠时，这是 ClawBot 最高信心的交易机会。

**场景**：
- Feb 12-14（3 天市场）和 Feb 13-20（7 天市场）重叠
- Feb 14 时 3 天市场结算 → 你知道 Feb 12-14 精确推文数
- 假设 3 天实际 = 72 条，日均 = 24
- 用 24/天 推算 Feb 13-20 预测 = 已有 1 天数据 + 24 × 6 = 约 168（加日历调整）
- 但 7 天市场如果仍然按日均 30 定价 → 220 附近 bin 高估 → 你买 160-180 bin

**为什么这是最强信号**：
- 你用的是**实际结算数据**（不是预测）
- 散户不会做这种精细的跨市场推算
- 做市商可能有，但反应需要时间

**触发规则**：
1. 检测到重叠市场（`dim_tracking_window` 时间段有交集）
2. 短期市场结算后立即获取 `fact_settlement.final_tweet_count`
3. 计算长期市场的速率推断
4. 与长期市场当前定价对比 → 如果偏差 > 8% → 交易

---

## 九、盈利模型

### 基于历史数据的回测推演

用 Jan 2026 衰退期做思想实验——这是趋势最强、最适合 ClawBot 的时期：

| 周 | 实际 | 统计预测 | 行为模式 | 融合预测 | 市场高概率 bin | 结果 |
|---|------|---------|---------|---------|-------------|------|
| Jan 16-23 | 470 | 534 | 480 | 500 | 520-540 | 市场高估，我们低估但更接近 |
| Jan 23-30 | 390 | 460 | 400 | 420 | 460-480 | 市场高估，我们低估但更接近 |
| Jan 30-Feb 6 | 290 | 380 | 310 | 340 | 380-400 | 市场高估，我们低估但更接近 |
| Feb 3-10 | 209 | 290 | 230 | 255 | 240-260 | 市场高估，我们 Top-2 命中 |

4 周中都比市场的最高概率 bin 更接近实际值。但我们也不完美——总是偏高。

原因：趋势的**加速度**很难捕捉（不仅在下降，还在加速下降）。校准系统会在 2-3 周后自动加入向下修正。

### 分场景月利润

| 场景 | 概率 | 月收益 |
|------|------|--------|
| 趋势期（连续方向变化） | 40% | +$80-150 |
| 震荡期（无明确方向） | 40% | -$10 to +$20 （少做或不做）|
| 突变期（暴涨暴跌） | 20% | -$20-40 |
| **加权月均** | | **+$25-60** |

### 与 Module 3 组合

| | 保守 | 正常 | 乐观 |
|---|------|------|------|
| Module 3 SpreadHunter | $57 | $125 | $195 |
| Module 4 ClawBot | $25 | $60 | $120 |
| **合计** | **$82** | **$185** | **$315** |
| Module 2 ArbitrageBot | +$30 | +$60 | +$100 |
| **三模块总计** | **$112** | **$245** | **$415** |

---

## 十、风险的诚实评估

### 这个策略可能失败的五个原因

1. **模型不比散户准**：如果 Top-1 准确率达不到 25%，正 EV 不存在。应对：paper trading 4 周验证
2. **做市商已 price in**：做市商可能有更好的数据源。应对：只在 edge > 8% 时交易
3. **执行摩擦**：spread 5-8% 可能吃掉理论 edge。应对：限价单不追价
4. **Elon 行为不可预测**：一条争议推文可能让他从日均 20 跳到日均 80。应对：硬止损 + 信号反转退出
5. **校准需要时间**：前 4-8 周可能净亏损。应对：paper trading，不着急上实盘

### 最坏场景控制

- 单周最多亏 $100（硬限制）
- 连续 4 周亏损 → 自动停机回到 paper trading
- 总回撤超过初始资金 20% → 全面审核策略

---

## 十一、服务器部署（52.49.214.146）

| 组件 | 延迟敏感？ | 资源需求 |
|------|----------|---------|
| 预测引擎 | 否（小时级运算） | CPU 轻负载 |
| LLM 调用 | 否（每周 2-4 次） | 网络 I/O |
| 市场监控 | 低（分钟级轮询） | CPU 轻负载 |
| 订单执行 | 低（限价单） | 网络 I/O |
| 数据库 | 否 | PostgreSQL 已部署 |

**结论**：爱尔兰服务器完全够用。所有操作在分钟/小时级，70ms 延迟零影响。

---

## 十二、开发路线

**Phase 0（1 周）**：数据验证
- 确认 `fact_tweet_metric_daily` 有 ≥8 周连续数据
- 确认 `fact_settlement` 有 ≥8 个已结算市场数据
- 手动跑一次 LLM 分析 prompt，评估输出质量

**Phase 1（3 周）**：预测引擎 + Paper Trading
- 实现 Layer 1-3 的预测逻辑
- 每个市场周期跑一次预测，与市场定价对比
- 不交易，纯记录
- 验收标准：Top-1 > 25%，Brier < 0.25

**Phase 2（2 周）**：Paper 交易模拟
- 模拟完整的入场/退出/仓位逻辑
- 计算 paper PnL
- 验收标准：Paper PnL > 0，Edge 实现率 > 50%

**Phase 3（持续）**：小额 Live
- $10-20/bin 实盘
- 完整风控 + 校准系统
- 连续 4 周盈利 → 扩大到 $50/bin
- 连续亏损 → 回到 paper
